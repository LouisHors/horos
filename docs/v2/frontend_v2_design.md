# ä¸‰åˆ†å±å‰ç«¯è®¾è®¡æ–‡æ¡£ V2

> ç‰ˆæœ¬: v2.0  
> æ—¥æœŸ: 2026-02-06  
> å…³è”: [ç³»ç»Ÿæ€»è§ˆ](./SYSTEM_OVERVIEW_V2.md)

---

## 1. è®¾è®¡æ¦‚è¿°

### 1.1 ç•Œé¢ç†å¿µ

ä¸‰åˆ†å±è®¾è®¡çš„æ ¸å¿ƒç†å¿µæ˜¯**"ä¿¡æ¯åˆ†å±‚ï¼Œå³æ—¶å¯è§"**:

- **å·¦ä¸Š (Agent Chat)**: å±•ç¤º"è°åœ¨åšä»€ä¹ˆ" - å›¢é˜Ÿåä½œè§†å›¾
- **å·¦ä¸‹ (Workflow Canvas)**: å±•ç¤º"æ•´ä½“è¿›åº¦å¦‚ä½•" - æ‰§è¡Œè§„åˆ’è§†å›¾  
- **å³ä¾§ (Project Explorer)**: å±•ç¤º"äº§å‡ºäº†ä»€ä¹ˆ" - æˆæœç‰©è§†å›¾

### 1.2 å¸ƒå±€æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              é¡¶éƒ¨å¯¼èˆªæ  (56px)                               â”‚
â”‚  Logo | é¡¹ç›®é€‰æ‹© | æ‰§è¡Œæ§åˆ¶ [è¿è¡Œ] [æš‚åœ] [é‡ç½®] | ç”¨æˆ·å¤´åƒ                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                       â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚        Agent Chat Panel         â”‚  â”‚  â”‚     Project Explorer           â”‚ â”‚
â”‚  â”‚         (40% height)            â”‚  â”‚  â”‚                                â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚  â”‚  ğŸ“ Project: Todo App          â”‚ â”‚
â”‚  â”‚                                 â”‚  â”‚  â”‚  â”œâ”€â”€ ğŸ“„ PRD.md                 â”‚ â”‚
â”‚  â”‚  ğŸ¤– CTO    10:23               â”‚  â”‚  â”‚  â”œâ”€â”€ ğŸ“„ Architecture.md        â”‚ â”‚
â”‚  â”‚  æ­£åœ¨è®¾è®¡æ•°æ®åº“æ¶æ„...           â”‚  â”‚  â”‚  â”œâ”€â”€ ğŸ“ src/                   â”‚ â”‚
â”‚  â”‚                                 â”‚  â”‚  â”‚  â”‚   â”œâ”€â”€ ğŸ“ components/         â”‚ â”‚
â”‚  â”‚  ğŸ“ äº§å“ç»ç† 10:24              â”‚  â”‚  â”‚  â”‚   â””â”€â”€ ğŸ“ pages/              â”‚ â”‚
â”‚  â”‚  @CTO ç”¨æˆ·éœ€è¦æ”¯æŒåä½œåŠŸèƒ½       â”‚  â”‚  â”‚  â””â”€â”€ ğŸ“ tests/                 â”‚ â”‚
â”‚  â”‚                                 â”‚  â”‚  â”‚                                â”‚ â”‚
â”‚  â”‚  [____________________] [å‘é€]  â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚  â”‚ ğŸ“Š å®æ—¶çŠ¶æ€               â”‚   â”‚ â”‚
â”‚                                       â”‚  â”‚  â”‚ å½“å‰: FrontendDev è¿è¡Œä¸­  â”‚   â”‚ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â”‚ è¿›åº¦: 3/5 èŠ‚ç‚¹å®Œæˆ        â”‚   â”‚ â”‚
â”‚  â”‚       Workflow Canvas           â”‚  â”‚  â”‚  â”‚ è€—æ—¶: 12m 34s            â”‚   â”‚ â”‚
â”‚  â”‚         (60% height)            â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚  â”‚                                â”‚ â”‚
â”‚  â”‚                                 â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚  â”‚       â”Œâ”€â”€â”€â”                     â”‚  â”‚  â”‚  â”‚ âš¡ æ“ä½œæŒ‰é’®              â”‚   â”‚ â”‚
â”‚  â”‚       â”‚Startâ”‚â”€â”€â”€â”               â”‚  â”‚  â”‚  â”‚ [âœ“ æ‰¹å‡†å¹¶æ‰§è¡Œ]         â”‚   â”‚ â”‚
â”‚  â”‚       â””â”€â”€â”€â”˜   â”‚                 â”‚  â”‚  â”‚  â”‚ [âœ ä¿®æ”¹å·¥ä½œæµ]         â”‚   â”‚ â”‚
â”‚  â”‚               â–¼                 â”‚  â”‚  â”‚  â”‚ [â¹ ä¸­æ–­æ‰§è¡Œ]           â”‚   â”‚ â”‚
â”‚  â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚  â”‚       â”‚ ğŸ¤– CTO    â”‚             â”‚  â”‚  â”‚                                â”‚ â”‚
â”‚  â”‚       â”‚ [è¿è¡Œä¸­]  â”‚             â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”‚       â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜             â”‚  â”‚                                     â”‚
â”‚  â”‚             â”‚                   â”‚  â”‚           (35% width)               â”‚
â”‚  â”‚             â–¼                   â”‚  â”‚                                     â”‚
â”‚  â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚  â”‚                                     â”‚
â”‚  â”‚       â”‚ ğŸ“ PM     â”‚             â”‚  â”‚                                     â”‚
â”‚  â”‚       â”‚ [å·²å®Œæˆ]  â”‚             â”‚  â”‚                                     â”‚
â”‚  â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚  â”‚                                     â”‚
â”‚  â”‚                                 â”‚  â”‚                                     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                                     â”‚
â”‚                                       â”‚                                     â”‚
â”‚           (65% width)                 â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.3 å“åº”å¼ç­–ç•¥

| å±å¹•å®½åº¦ | å¸ƒå±€è°ƒæ•´ |
|---------|---------|
| > 1440px | ä¸‰åˆ†å±å®Œæ•´æ˜¾ç¤º |
| 1280-1440px | å³ä¾§é¢æ¿å˜çª„ |
| 1024-1280px | å³ä¾§é¢æ¿å¯æŠ˜å  |
| < 1024px | åˆ‡æ¢ä¸ºæ ‡ç­¾é¡µæ¨¡å¼ |

---

## 2. ç»„ä»¶æ¶æ„

### 2.1 æ•´ä½“ç»„ä»¶æ ‘

```
App
â”œâ”€â”€ TopNavigation
â”‚   â”œâ”€â”€ Logo
â”‚   â”œâ”€â”€ ProjectSelector
â”‚   â”œâ”€â”€ ExecutionControls
â”‚   â””â”€â”€ UserMenu
â”‚
â”œâ”€â”€ MainLayout (SplitPane)
â”‚   â”œâ”€â”€ LeftPanel (65%)
â”‚   â”‚   â”œâ”€â”€ SplitPane (vertical)
â”‚   â”‚   â”‚   â”œâ”€â”€ AgentChatPanel (40%)
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ AgentAvatarList
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ MessageList (Virtualized)
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ MessageItem
â”‚   â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ Avatar
â”‚   â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ Content
â”‚   â”‚   â”‚   â”‚   â”‚       â””â”€â”€ Reactions
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ MessageInput
â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ TextArea
â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ MentionSelector
â”‚   â”‚   â”‚   â”‚       â””â”€â”€ SendButton
â”‚   â”‚   â”‚   â”‚
â”‚   â”‚   â”‚   â””â”€â”€ WorkflowCanvas (60%)
â”‚   â”‚   â”‚       â”œâ”€â”€ ReactFlow
â”‚   â”‚   â”‚       â”‚   â”œâ”€â”€ Background
â”‚   â”‚   â”‚       â”‚   â”œâ”€â”€ Controls
â”‚   â”‚   â”‚       â”‚   â”œâ”€â”€ MiniMap
â”‚   â”‚   â”‚       â”‚   â”œâ”€â”€ AgentNode
â”‚   â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ NodeHeader (Avatar + Name + Status)
â”‚   â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ NodeContent (Progress/Output)
â”‚   â”‚   â”‚       â”‚   â”‚   â””â”€â”€ NodeToolbar
â”‚   â”‚   â”‚       â”‚   â””â”€â”€ ConnectionLine
â”‚   â”‚   â”‚       â””â”€â”€ ExecutionOverlay
â”‚   â”‚   â”‚           â”œâ”€â”€ ProgressBar
â”‚   â”‚   â”‚           â””â”€â”€ StatusIndicators
â”‚   â”‚   â”‚
â”‚   â””â”€â”€ RightPanel (35%)
â”‚       â”œâ”€â”€ ProjectExplorer
â”‚       â”‚   â”œâ”€â”€ FileTree
â”‚       â”‚   â”‚   â””â”€â”€ FileTreeItem (recursive)
â”‚       â”‚   â””â”€â”€ FileViewer (Code Editor)
â”‚       â”œâ”€â”€ StatusPanel
â”‚       â”‚   â”œâ”€â”€ ExecutionProgress
â”‚       â”‚   â”œâ”€â”€ AgentStatusList
â”‚       â”‚   â””â”€â”€ PerformanceMetrics
â”‚       â””â”€â”€ ActionPanel
â”‚           â”œâ”€â”€ PrimaryActions
â”‚           â””â”€â”€ SecondaryActions
â”‚
â””â”€â”€ Modals
    â”œâ”€â”€ AgentDetailModal
    â”œâ”€â”€ FilePreviewModal
    â””â”€â”€ SettingsModal
```

---

## 3. å·¦ä¸Šé¢æ¿: Agent Chat Panel

### 3.1 åŠŸèƒ½å®šä½

å±•ç¤º Agent å›¢é˜Ÿçš„å®æ—¶åä½œå¯¹è¯ï¼Œç”¨æˆ·å¯:
- æŸ¥çœ‹æ‰€æœ‰ Agent çš„å‘è¨€
- @æåŠç‰¹å®š Agent è¿›è¡Œè¯¢é—®
- å®æ—¶çœ‹åˆ° Agent çš„æ€è€ƒè¿‡ç¨‹

### 3.2 ç»„ä»¶è®¾è®¡

```typescript
// AgentAvatarList - é¡¶éƒ¨å¤´åƒåˆ—è¡¨
interface AgentAvatarListProps {
  agents: {
    id: string;
    name: string;
    avatar: string;
    role: string;
    status: 'idle' | 'working' | 'completed' | 'error';
  }[];
  onAgentClick: (agentId: string) => void;
}

// MessageList - æ¶ˆæ¯åˆ—è¡¨ï¼ˆè™šæ‹Ÿæ»šåŠ¨ï¼‰
interface MessageListProps {
  messages: Message[];
  currentUserId: string;
  onLoadMore: () => Promise<void>;
  onReply: (messageId: string) => void;
  onReaction: (messageId: string, emoji: string) => void;
}

// MessageItem - å•æ¡æ¶ˆæ¯
interface MessageItemProps {
  message: Message;
  isMe: boolean;
  showAvatar: boolean; // è¿ç»­æ¶ˆæ¯ä¸é‡å¤æ˜¾ç¤ºå¤´åƒ
  onMentionClick: (agentId: string) => void;
  onFileClick: (filePath: string) => void;
}
```

### 3.3 æ¶ˆæ¯ç±»å‹æ¸²æŸ“

```tsx
// æ™®é€šèŠå¤©æ¶ˆæ¯
const ChatMessage: React.FC<{ message: Message }> = ({ message }) => (
  <div className={`message ${message.sender.id === 'user' ? 'me' : 'agent'}`}>
    <Avatar src={message.sender.avatar} status={message.sender.status} />
    <div className="content">
      <div className="header">
        <span className="name">{message.sender.name}</span>
        <span className="time">{formatTime(message.metadata.timestamp)}</span>
      </div>
      <div className="text">
        <MentionHighlighter text={message.content.text} />
      </div>
      <MessageReactions reactions={message.metadata.reactions} />
    </div>
  </div>
);

// æ–‡ä»¶å˜æ›´æ¶ˆæ¯
const FileMessage: React.FC<{ message: Message }> = ({ message }) => (
  <div className="message file-message">
    <FileIcon type={getFileType(message.content.file!.path)} />
    <div className="file-info">
      <div className="filename">{message.content.file!.path}</div>
      {message.content.file!.diff && (
        <DiffViewer diff={message.content.file!.diff} />
      )}
    </div>
  </div>
);

// ç³»ç»ŸçŠ¶æ€æ¶ˆæ¯
const SystemMessage: React.FC<{ message: Message }> = ({ message }) => (
  <div className="message system-message">
    <StatusIcon status={message.content.status} />
    <span>{message.content.text}</span>
  </div>
);
```

### 3.4 è¾“å…¥æ¡†ä¸@åŠŸèƒ½

```tsx
const MessageInput: React.FC = () => {
  const [text, setText] = useState('');
  const [mentionQuery, setMentionQuery] = useState('');
  const [showMentionList, setShowMentionList] = useState(false);
  
  const handleInput = (e: React.ChangeEvent<HTMLTextAreaElement>) => {
    const value = e.target.value;
    setText(value);
    
    // æ£€æµ‹@è§¦å‘
    const match = value.match(/@([\w]*)$/);
    if (match) {
      setMentionQuery(match[1]);
      setShowMentionList(true);
    } else {
      setShowMentionList(false);
    }
  };
  
  const insertMention = (agent: Agent) => {
    const newText = text.replace(/@([\w]*)$/, `@${agent.name} `);
    setText(newText);
    setShowMentionList(false);
  };
  
  return (
    <div className="message-input">
      <textarea
        value={text}
        onChange={handleInput}
        placeholder="è¾“å…¥æ¶ˆæ¯ï¼Œä½¿ç”¨ @ æåŠAgent..."
        rows={3}
      />
      {showMentionList && (
        <MentionSelector
          query={mentionQuery}
          onSelect={insertMention}
        />
      )}
      <button onClick={sendMessage}>å‘é€</button>
    </div>
  );
};
```

---

## 4. å·¦ä¸‹é¢æ¿: Workflow Canvas

### 4.1 åŠŸèƒ½å®šä½

å¯è§†åŒ–å±•ç¤ºå·¥ä½œæµç»“æ„å’Œæ‰§è¡Œè¿›åº¦ï¼Œæ”¯æŒ:
- AI ç”Ÿæˆçš„å·¥ä½œæµé¢„è§ˆ
- ç”¨æˆ·æ‰‹åŠ¨ç¼–è¾‘è°ƒæ•´
- å®æ—¶æ‰§è¡ŒçŠ¶æ€åé¦ˆ

### 4.2 è‡ªå®šä¹‰èŠ‚ç‚¹è®¾è®¡

```tsx
// AgentNode - Agent æ‰§è¡ŒèŠ‚ç‚¹
const AgentNode: React.FC<NodeProps<AgentNodeData>> = ({ data, selected }) => {
  const statusColors = {
    idle: '#94a3b8',
    running: '#3b82f6',
    completed: '#22c55e',
    error: '#ef4444',
    paused: '#f59e0b'
  };
  
  return (
    <div className={`agent-node ${selected ? 'selected' : ''}`}>
      {/* çŠ¶æ€æŒ‡ç¤ºå™¨è¾¹æ¡† */}
      <div 
        className="status-border"
        style={{ borderColor: statusColors[data.status] }}
      />
      
      {/* èŠ‚ç‚¹å¤´éƒ¨ */}
      <div className="node-header">
        <span className="avatar">{data.roleIcon}</span>
        <span className="name">{data.roleName}</span>
        <StatusBadge status={data.status} />
      </div>
      
      {/* èŠ‚ç‚¹å†…å®¹ */}
      <div className="node-content">
        <div className="title">{data.taskTitle}</div>
        
        {data.status === 'running' && (
          <div className="progress">
            <ProgressBar percent={data.progress} />
            <span className="time">{data.elapsedTime}</span>
          </div>
        )}
        
        {data.status === 'completed' && data.output && (
          <div className="output-preview">
            {truncate(data.output.summary, 50)}
          </div>
        )}
      </div>
      
      {/* æ“ä½œæŒ‰é’® */}
      <div className="node-toolbar">
        <button onClick={() => viewDetails(data.agentId)}>è¯¦æƒ…</button>
        {data.status === 'running' && (
          <button onClick={() => pauseAgent(data.agentId)}>æš‚åœ</button>
        )}
      </div>
      
      {/* è¿æ¥ç‚¹ */}
      <Handle type="target" position={Position.Top} />
      <Handle type="source" position={Position.Bottom} />
    </div>
  );
};

// èŠ‚ç‚¹æ ·å¼ (Tailwind)
const agentNodeStyles = `
  .agent-node {
    @apply w-64 bg-white rounded-lg shadow-md overflow-hidden;
    @apply border-2 transition-all duration-300;
  }
  
  .agent-node.selected {
    @apply shadow-lg ring-2 ring-blue-500;
  }
  
  .agent-node .node-header {
    @apply flex items-center gap-2 px-3 py-2 bg-gray-50 border-b;
  }
  
  .agent-node .avatar {
    @apply text-2xl;
  }
  
  .agent-node .node-content {
    @apply p-3;
  }
  
  .agent-node .progress {
    @apply mt-2;
  }
`;
```

### 4.3 æ‰§è¡ŒçŠ¶æ€å åŠ å±‚

```tsx
const ExecutionOverlay: React.FC = () => {
  const execution = useExecutionStore(state => state.currentExecution);
  
  if (!execution) return null;
  
  return (
    <div className="execution-overlay">
      {/* æ€»ä½“è¿›åº¦æ¡ */}
      <div className="global-progress">
        <div className="info">
          <span className="status">{execution.status}</span>
          <span className="count">
            {execution.completedNodes}/{execution.totalNodes} å®Œæˆ
          </span>
        </div>
        <ProgressBar 
          percent={(execution.completedNodes / execution.totalNodes) * 100}
          animated={execution.status === 'running'}
        />
      </div>
      
      {/* å½“å‰æ‰§è¡ŒèŠ‚ç‚¹é«˜äº® */}
      {execution.currentNodeId && (
        <NodeHighlighter nodeId={execution.currentNodeId} />
      )}
    </div>
  );
};
```

---

## 5. å³ä¾§é¢æ¿: Project Explorer

### 5.1 åŠŸèƒ½å®šä½

å±•ç¤ºé¡¹ç›®æ–‡ä»¶ç»“æ„ï¼Œæ”¯æŒ:
- æ–‡ä»¶æ ‘æµè§ˆ
- ä»£ç æŸ¥çœ‹å’Œç¼–è¾‘
- æ–‡ä»¶å˜æ›´å†å²
- å®æ—¶çŠ¶æ€æŒ‡ç¤º

### 5.2 æ–‡ä»¶æ ‘ç»„ä»¶

```tsx
interface FileTreeItemProps {
  item: FileNode;
  level: number;
  expanded: boolean;
  selected: boolean;
  onToggle: () => void;
  onSelect: () => void;
}

const FileTreeItem: React.FC<FileTreeItemProps> = ({
  item, level, expanded, selected, onToggle, onSelect
}) => {
  const isFolder = item.type === 'directory';
  const Icon = isFolder 
    ? (expanded ? FolderOpen : Folder)
    : getFileIcon(item.name);
  
  return (
    <div className="file-tree-item-wrapper">
      <div
        className={`file-tree-item ${selected ? 'selected' : ''}`}
        style={{ paddingLeft: level * 16 + 8 }}
        onClick={isFolder ? onToggle : onSelect}
      >
        {isFolder && (
          <ChevronRight 
            className={`chevron ${expanded ? 'expanded' : ''}`}
            size={16}
          />
        )}
        <Icon size={16} className="icon" />
        <span className="name">{item.name}</span>
        
        {/* çŠ¶æ€æŒ‡ç¤º */}
        {item.status && (
          <FileStatusBadge status={item.status} />
        )}
      </div>
      
      {/* é€’å½’æ¸²æŸ“å­é¡¹ */}
      {isFolder && expanded && item.children?.map(child => (
        <FileTreeItem
          key={child.path}
          item={child}
          level={level + 1}
          {...childProps}
        />
      ))}
    </div>
  );
};
```

### 5.3 ä»£ç ç¼–è¾‘å™¨é›†æˆ

```tsx
const FileViewer: React.FC = () => {
  const currentFile = useFileStore(state => state.currentFile);
  
  if (!currentFile) {
    return (
      <div className="empty-state">
        é€‰æ‹©æ–‡ä»¶æŸ¥çœ‹ä»£ç 
      </div>
    );
  }
  
  return (
    <div className="file-viewer">
      <div className="file-header">
        <span className="filename">{currentFile.path}</span>
        <div className="actions">
          <button onClick={viewHistory}>å†å²</button>
          <button onClick={editFile}>ç¼–è¾‘</button>
        </div>
      </div>
      
      <MonacoEditor
        value={currentFile.content}
        language={getLanguage(currentFile.path)}
        theme="vs-dark"
        options={{
          readOnly: !currentFile.isEditable,
          minimap: { enabled: false }
        }}
      />
    </div>
  );
};
```

### 5.4 çŠ¶æ€é¢æ¿

```tsx
const StatusPanel: React.FC = () => {
  const execution = useExecutionStore(state => state.currentExecution);
  const agents = useAgentStore(state => state.agents);
  
  return (
    <div className="status-panel">
      {/* æ‰§è¡Œè¿›åº¦ */}
      <Section title="æ‰§è¡Œè¿›åº¦">
        <div className="execution-status">
          <StatusIcon status={execution?.status} />
          <span className="status-text">{execution?.status}</span>
          <span className="duration">{execution?.duration}</span>
        </div>
      </Section>
      
      {/* Agent çŠ¶æ€åˆ—è¡¨ */}
      <Section title="Agent çŠ¶æ€">
        {agents.map(agent => (
          <AgentStatusItem
            key={agent.id}
            name={agent.name}
            icon={agent.icon}
            status={agent.status}
            currentTask={agent.currentTask}
          />
        ))}
      </Section>
    </div>
  );
};
```

---

## 6. çŠ¶æ€ç®¡ç†

### 6.1 Zustand Store è®¾è®¡

```typescript
// æ ¹ Store
interface AppState {
  // å¸ƒå±€çŠ¶æ€
  layout: {
    leftPanelWidth: number;
    chatPanelHeight: number;
    rightPanelCollapsed: boolean;
  };
  
  // æ‰§è¡ŒçŠ¶æ€
  execution: {
    status: 'idle' | 'generating' | 'reviewing' | 'running' | 'completed' | 'error';
    currentWorkflow: Workflow | null;
    progress: ExecutionProgress;
  };
  
  // Agent çŠ¶æ€
  agents: Agent[];
  messages: Message[];
  
  // æ–‡ä»¶çŠ¶æ€
  files: FileNode[];
  currentFile: FileNode | null;
}

// ç‹¬ç«‹çš„ Slice Store
const useLayoutStore = create<LayoutState>((set) => ({
  leftPanelWidth: 65,
  chatPanelHeight: 40,
  rightPanelCollapsed: false,
  
  setLeftPanelWidth: (width) => set({ leftPanelWidth: width }),
  setChatPanelHeight: (height) => set({ chatPanelHeight: height }),
  toggleRightPanel: () => set(state => ({ 
    rightPanelCollapsed: !state.rightPanelCollapsed 
  }))
}));

const useExecutionStore = create<ExecutionState>((set, get) => ({
  status: 'idle',
  currentWorkflow: null,
  progress: { completed: 0, total: 0 },
  
  startGeneration: () => set({ status: 'generating' }),
  
  submitForReview: (workflow) => set({ 
    status: 'reviewing', 
    currentWorkflow: workflow 
  }),
  
  startExecution: () => set({ status: 'running' }),
  
  updateProgress: (progress) => set({ progress }),
  
  completeExecution: () => set({ status: 'completed' }),
  
  pauseExecution: () => {
    // è°ƒç”¨ API æš‚åœ
    api.execution.pause();
    set({ status: 'paused' });
  }
}));

const useMessageStore = create<MessageState>((set, get) => ({
  messages: [],
  hasMore: true,
  
  addMessage: (message) => set(state => ({
    messages: [...state.messages, message]
  })),
  
  loadMore: async () => {
    const oldestId = get().messages[0]?.id;
    const more = await api.messages.getHistory({ before: oldestId });
    set(state => ({
      messages: [...more, ...state.messages],
      hasMore: more.length === 50
    }));
  },
  
  // WebSocket æ¶ˆæ¯å¤„ç†
  handleRealtimeMessage: (message) => {
    get().addMessage(message);
    // æ»šåŠ¨åˆ°åº•éƒ¨
    scrollToBottom();
  }
}));
```

---

## 7. å®æ—¶é€šä¿¡

### 7.1 WebSocket ç®¡ç†

```typescript
class WebSocketManager {
  private ws: WebSocket | null = null;
  private reconnectAttempts = 0;
  private maxReconnectAttempts = 5;
  
  connect(projectId: string) {
    const wsUrl = `wss://api.example.com/ws/v2/projects/${projectId}`;
    this.ws = new WebSocket(wsUrl);
    
    this.ws.onopen = () => {
      console.log('WebSocket connected');
      this.reconnectAttempts = 0;
    };
    
    this.ws.onmessage = (event) => {
      const message = JSON.parse(event.data);
      this.handleMessage(message);
    };
    
    this.ws.onclose = () => {
      this.attemptReconnect(projectId);
    };
    
    this.ws.onerror = (error) => {
      console.error('WebSocket error:', error);
    };
  }
  
  private handleMessage(message: WebSocketMessage) {
    switch (message.type) {
      case 'agent_message':
        useMessageStore.getState().handleRealtimeMessage(message.payload);
        break;
        
      case 'execution_progress':
        useExecutionStore.getState().updateProgress(message.payload);
        break;
        
      case 'file_change':
        useFileStore.getState().handleFileChange(message.payload);
        break;
        
      case 'agent_status_change':
        useAgentStore.getState().updateAgentStatus(message.payload);
        break;
    }
  }
  
  private attemptReconnect(projectId: string) {
    if (this.reconnectAttempts < this.maxReconnectAttempts) {
      this.reconnectAttempts++;
      setTimeout(() => this.connect(projectId), 1000 * this.reconnectAttempts);
    }
  }
}
```

---

## 8. API é›†æˆ

```typescript
// API Client
const api = {
  // Master Agent
  master: {
    analyze: (text: string) => 
      axios.post('/api/v2/master/analyze', { text }),
    
    generate: (analysis: RequirementAnalysis) =>
      axios.post('/api/v2/master/plan', { analysis }),
    
    approve: (reviewQueueId: string) =>
      axios.post(`/api/v2/master/review/${reviewQueueId}/approve`),
    
    modify: (reviewQueueId: string, workflow: WorkflowDSL) =>
      axios.post(`/api/v2/master/review/${reviewQueueId}/modify`, { workflow })
  },
  
  // Execution
  execution: {
    start: (workflowId: string) =>
      axios.post(`/api/v2/execution/${workflowId}/start`),
    
    pause: () =>
      axios.post('/api/v2/execution/pause'),
    
    resume: () =>
      axios.post('/api/v2/execution/resume'),
    
    stop: () =>
      axios.post('/api/v2/execution/stop')
  },
  
  // Messages
  messages: {
    send: (groupId: string, content: string, mentions?: string[]) =>
      axios.post('/api/v2/messages', { groupId, content, mentions }),
    
    getHistory: (params: { groupId: string; before?: string; limit?: number }) =>
      axios.get('/api/v2/messages', { params })
  },
  
  // Files
  files: {
    getTree: (projectId: string) =>
      axios.get(`/api/v2/files/${projectId}/tree`),
    
    getContent: (path: string) =>
      axios.get(`/api/v2/files/${path}`),
    
    update: (path: string, content: string) =>
      axios.put(`/api/v2/files/${path}`, { content })
  }
};
```

---

## 9. æ€§èƒ½ä¼˜åŒ–

### 9.1 è™šæ‹Ÿæ»šåŠ¨

```tsx
import { Virtuoso } from 'react-virtuoso';

const VirtualMessageList: React.FC = () => {
  const messages = useMessageStore(state => state.messages);
  
  return (
    <Virtuoso
      data={messages}
      itemContent={(index, message) => (
        <MessageItem 
          message={message}
          isMe={message.sender.id === 'user'}
        />
      )}
      followOutput="smooth" // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
      atBottomStateChange={(atBottom) => {
        // å¦‚æœç”¨æˆ·æ‰‹åŠ¨æ»šåŠ¨ä¸Šå»ï¼Œæš‚åœè‡ªåŠ¨æ»šåŠ¨
      }}
    />
  );
};
```

### 9.2 ä»£ç åˆ†å‰²

```tsx
// åŠ¨æ€åŠ è½½ Monaco Editor
const MonacoEditor = lazy(() => import('@monaco-editor/react'));

// åŠ¨æ€åŠ è½½ Diff Viewer
const DiffViewer = lazy(() => import('./DiffViewer'));
```

---

**ä¸‹ä¸€æ­¥**: å®ç°ä¸‰åˆ†å±å¸ƒå±€å’Œæ ¸å¿ƒç»„ä»¶ã€‚
