# AI Agent 可视化编排工具 V2 - 系统架构总览

> 版本: v2.0  
> 日期: 2026-02-06  
> 状态: 详细设计阶段  
> 关联文档:
> - [Master Agent 设计](./master_agent_design.md)
> - [Agent Runtime 设计](./agent_runtime_design.md)
> - [三分屏前端设计](./frontend_v2_design.md)
> - [数据模型 V2](./data_model_v2_design.md)
> - [IM 消息总线设计](./message_bus_design.md)
> - [API 接口设计](./api_design_v2.md)

---

## 1. 设计目标

### 1.1 核心转变

| 维度 | V1 (当前) | V2 (目标) |
|------|----------|----------|
| **交互模式** | 用户手动编排工作流 | AI生成工作流 + 用户审核修改 |
| **组织方式** | 节点图 | Agent团队 + 工作流 |
| **开发模式** | 画图执行 | 自然语言需求驱动 |
| **可视化** | 单一画布 | 三分屏（群聊+画布+文件） |
| **干预时机** | 执行前配置 | 事前审核 + 事中干预 |

### 1.2 关键能力矩阵

```
┌─────────────────────────────────────────────────────────────┐
│                      V2 核心能力                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │   智能生成   │  │   人机协作   │  │   实时可视   │      │
│  │              │  │              │  │              │      │
│  │ • 需求解析   │  │ • 事前审核   │  │ • Agent群聊  │      │
│  │ • 角色规划   │  │ • 事中干预   │  │ • 执行进度   │      │
│  │ • 任务拆分   │  │ • 上下文修改 │  │ • 文件生成   │      │
│  │ • 工作流生成 │  │ • 人工决策   │  │ • 状态同步   │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
│                                                             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │   角色系统   │  │   自驱执行   │  │   版本管理   │      │
│  │              │  │              │  │              │      │
│  │ • 预定义模板 │  │ • Agent自运行│  │ • 工作流版本 │      │
│  │ • 动态创建   │  │ • 消息驱动   │  │ • 文件版本   │      │
│  │ • 能力定义   │  │ • 协作协商   │  │ • 回滚恢复   │      │
│  │ • 产出规范   │  │ • 冲突解决   │  │ • 分支管理   │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 2. 系统全景架构

### 2.1 分层架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              表现层 (Presentation)                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                     三分屏界面 (Tri-Pane UI)                         │   │
│  │                                                                     │   │
│  │  ┌───────────────────────────────┬────────────────────────────────┐ │   │
│  │  │    左上: Agent Chat Panel     │    右侧: Project Explorer     │ │   │
│  │  │    ┌──────────────────────┐   │    ┌──────────────────────┐   │ │   │
│  │  │    │ AgentAvatarList      │   │    │ FileTree             │   │ │   │
│  │  │    │ MessageHistory       │   │    │ FileEditor           │   │ │   │
│  │  │    │ MessageInput         │   │    │ VersionHistory       │   │ │   │
│  │  │    └──────────────────────┘   │    └──────────────────────┘   │ │   │
│  │  ├───────────────────────────────┤    │ RealtimeIndicators   │   │ │   │
│  │  │    左下: Workflow Canvas      │    └──────────────────────┘   │ │   │
│  │  │    ┌──────────────────────┐   │                                 │ │   │
│  │  │    │ ReactFlow Graph      │   │                                 │ │   │
│  │  │    │ NodeEditor           │   │                                 │ │   │
│  │  │    │ ExecutionControls    │   │                                 │ │   │
│  │  │    └──────────────────────┘   │                                 │ │   │
│  │  └───────────────────────────────┴────────────────────────────────┘ │   │
│  │                                                                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              API 网关层 (API Gateway)                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │ 认证/授权   │  │ 限流控制    │  │ 路由分发    │  │ 请求转换    │        │
│  │ Auth        │  │ Rate Limit  │  │ Routing     │  │ Transform   │        │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘        │
│                                                                             │
│  REST API: /api/v2/master/*, /api/v2/agents/*, /api/v2/messages/*          │
│  WebSocket: /ws/v2/projects/:id (实时推送)                                  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           核心业务层 (Core Services)                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    Master Agent Service                             │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌────────────┐ │   │
│  │  │ Requirement │  │ RolePlanner │  │  Task       │  │ Workflow   │ │   │
│  │  │ Parser      │  │             │  │ Decomposer  │  │ Generator  │ │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └────────────┘ │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    Agent Runtime Service                            │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌────────────┐ │   │
│  │  │ AgentPool   │  │ MessageBus  │  │ StateManager│  │ ContextMgr │ │   │
│  │  │ (角色实例池) │  │ (IM消息总线) │  │ (状态管理)  │  │ (上下文)   │ │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └────────────┘ │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    Execution Engine Service                         │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌────────────┐ │   │
│  │  │ DAGParser   │  │ Scheduler   │  │ NodeExecutor│  │ Checkpoint │ │   │
│  │  │ (DAG解析)   │  │ (调度器)    │  │ (节点执行)  │  │ (检查点)   │ │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └────────────┘ │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    Supporting Services                              │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌────────────┐ │   │
│  │  │ FileManager │  │ ReviewQueue │  │ ArtifactMgr │  │ EventBus   │ │   │
│  │  │ (文件管理)  │  │ (审核队列)  │  │ (产物管理)  │  │ (事件总线) │ │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └────────────┘ │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            数据存储层 (Data Layer)                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │ PostgreSQL  │  │    Redis    │  │    MinIO    │  │ Elasticsearch│       │
│  │ ─────────── │  │ ─────────── │  │ ─────────── │  │ ─────────── │       │
│  │ • Workflows │  │ • Sessions  │  │ • Files     │  │ • Messages  │       │
│  │ • Agents    │  │ • Caches    │  │ • Artifacts │  │ • Logs      │       │
│  │ • Users     │  │ • Pub/Sub   │  │ • Checkpoints│ │ • Search    │       │
│  │ • Projects  │  │ • Streams   │  │             │  │             │       │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘        │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                          外部集成层 (External Integration)                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │  LLM APIs   │  │   GitHub    │  │    MCP      │  │   Others    │        │
│  │ ─────────── │  │ ─────────── │  │ ─────────── │  │ ─────────── │        │
│  │ • Zhipu AI  │  │ • Repo Ops  │  │ • Tools     │  │ • Email     │        │
│  │ • OpenAI    │  │ • PR/Issue  │  │ • External  │  │ • Slack     │        │
│  │ • Claude    │  │ • Actions   │  │   Functions │  │ • Webhook   │        │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘        │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 3. 核心服务详解

### 3.1 Master Agent Service

**职责**: 理解用户需求，规划执行策略，生成可执行工作流

```
输入: 自然语言需求 (如"开发一个Todo App")
  │
  ▼
┌─────────────────────────────────────────┐
│ Step 1: RequirementParser (需求解析)    │
│ ─────────────────────────────────────── │
│ • 任务类型识别 (WebApp/Mobile/API/...)  │
│ • 功能点提取                            │
│ • 技术约束识别                          │
│ • 复杂度评估                            │
└─────────────────────────────────────────┘
  │
  ▼ 输出: RequirementAnalysis
  │
┌─────────────────────────────────────────┐
│ Step 2: RolePlanner (角色规划)          │
│ ─────────────────────────────────────── │
│ • 选择需要的角色组合                    │
│ • 分配职责边界                          │
│ • 确定协作关系                          │
└─────────────────────────────────────────┘
  │
  ▼ 输出: RoleAssignment[]
  │
┌─────────────────────────────────────────┐
│ Step 3: TaskDecomposer (任务拆分)       │
│ ─────────────────────────────────────── │
│ • 为每个角色生成子任务                  │
│ • 分析任务依赖关系                      │
│ • 标记并行/串行执行                     │
│ • 估算工作量                            │
└─────────────────────────────────────────┘
  │
  ▼ 输出: TaskGraph
  │
┌─────────────────────────────────────────┐
│ Step 4: WorkflowGenerator (工作流生成)  │
│ ─────────────────────────────────────── │
│ • 转换为 ReactFlow 节点                 │
│ • 自动布局 (Dagre/Elk)                  │
│ • 生成节点配置                          │
│ • 创建审核队列项                        │
└─────────────────────────────────────────┘
  │
  ▼ 输出: WorkflowDSL + ReviewQueueItem
```

### 3.2 Agent Runtime Service

**职责**: 管理 Agent 生命周期，提供消息通信，维护执行状态

```
┌─────────────────────────────────────────┐
│           Agent Runtime 架构             │
├─────────────────────────────────────────┤
│                                         │
│  ┌─────────────────────────────────┐   │
│  │        Agent Pool (实例池)       │   │
│  │  ┌─────────┐ ┌─────────┐       │   │
│  │  │ Agent-1 │ │ Agent-2 │ ...   │   │
│  │  │ (CTO)   │ │ (PM)    │       │   │
│  │  │ Status  │ │ Status  │       │   │
│  │  │ Context │ │ Context │       │   │
│  │  └─────────┘ └─────────┘       │   │
│  └──────────────┬──────────────────┘   │
│                 │                      │
│                 ▼                      │
│  ┌─────────────────────────────────┐   │
│  │       Message Bus (消息总线)     │   │
│  │  ┌─────────────────────────┐   │   │
│  │  │  Group: project-123     │   │   │
│  │  │  ├─ Message[]           │   │   │
│  │  │  ├─ Subscribers[]       │   │   │
│  │  │  └─ UnreadTracker       │   │   │
│  │  └─────────────────────────┘   │   │
│  │  • Redis Streams (持久化)      │   │
│  │  • Pub/Sub (实时推送)          │   │
│  └─────────────────────────────────┘   │
│                 │                      │
│                 ▼                      │
│  ┌─────────────────────────────────┐   │
│  │      State Manager (状态管理)    │   │
│  │  • Agent状态机                  │   │
│  │  • 任务状态追踪                 │   │
│  │  • 上下文持久化                 │   │
│  └─────────────────────────────────┘   │
│                                         │
└─────────────────────────────────────────┘
```

### 3.3 Execution Engine Service

**职责**: 执行工作流，调度节点，管理检查点

与 V1 相比的增强:
- 支持 Agent 节点 (调用 Agent Runtime)
- 支持暂停/恢复 (事中干预)
- 更细粒度的进度上报

---

## 4. 数据流向

### 4.1 主流程数据流

```
┌─────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐
│  User   │───▶│  Master  │───▶│ Review   │───▶│  Agent   │───▶│ Execution│
│ Request │    │  Agent   │    │  Queue   │    │ Runtime  │    │  Engine  │
└─────────┘    └──────────┘    └──────────┘    └──────────┘    └──────────┘
     │               │               │               │               │
     │ 需求文本       │ 分析结果      │ 工作流DSL      │ 执行计划      │ 节点输出
     │               │               │               │               │
     ▼               ▼               ▼               ▼               ▼
┌─────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐
│ 需求记录 │    │ 角色分配  │    │ 审核状态  │    │ Agent状态 │    │ 执行日志  │
│          │    │ 任务图   │    │ 修改记录  │    │ 消息历史  │    │ 检查点   │
└─────────┘    └──────────┘    └──────────┘    └──────────┘    └──────────┘
```

### 4.2 实时通信数据流

```
Agent-1                      Message Bus                    WebSocket
   │                              │                              │
   │ 发送消息                      │                              │
   │─────────────────────────────▶│                              │
   │                              │                              │
   │                              │ 广播消息                      │
   │                              │─────────────────────────────▶│
   │                              │                              │
   │                              │                              │ 推送 Frontend
   │                              │                              │──────────▶
   │                              │                              │
   │ 接收消息(拉取/WebSocket)     │                              │
   │◀─────────────────────────────│                              │
```

---

## 5. 模块间依赖关系

```
┌─────────────────────────────────────────────────────────────────┐
│                      模块依赖图                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────────────┐                                          │
│  │  Frontend (三分屏) │                                          │
│  │  ───────────────  │                                          │
│  │  依赖: API, WS    │                                          │
│  └────────┬─────────┘                                          │
│           │                                                     │
│           ▼                                                     │
│  ┌──────────────────┐    ┌──────────────────┐                  │
│  │  API Gateway     │◀───│  WebSocket Server│                  │
│  │  ───────────────  │    │  ───────────────  │                  │
│  │  路由/认证/限流   │    │  实时推送         │                  │
│  └────────┬─────────┘    └──────────────────┘                  │
│           │                                                     │
│     ┌─────┴─────┬─────────────┐                                │
│     │           │             │                                │
│     ▼           ▼             ▼                                │
│  ┌──────┐   ┌────────┐   ┌────────────┐                       │
│  │Master│   │ Agent  │   │ Execution  │                       │
│  │Agent │   │Runtime │   │  Engine    │                       │
│  └──┬───┘   └───┬────┘   └─────┬──────┘                       │
│     │          │              │                                │
│     │          │ 依赖          │                                │
│     │          └─────────────▶│                                │
│     │                         │                                │
│     └───────────────────────▶ │                                │
│                               │                                │
│     ┌─────────────────────────┘                                │
│     │                                                           │
│     ▼                                                           │
│  ┌─────────────────────────────────────────┐                   │
│  │          Shared Services               │                   │
│  │  ┌──────────┐ ┌──────────┐ ┌────────┐  │                   │
│  │  │ FileMgr  │ │ MsgBus   │ │ LLM    │  │                   │
│  │  └──────────┘ └──────────┘ └────────┘  │                   │
│  └─────────────────────────────────────────┘                   │
│           │                                                     │
│           ▼                                                     │
│  ┌─────────────────────────────────────────┐                   │
│  │              Data Layer                │                   │
│  └─────────────────────────────────────────┘                   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 6. 技术选型决策

| 领域 | 技术选型 | 理由 |
|------|---------|------|
| **前端框架** | Next.js 16 + React 19 | App Router, Server Components, 支持API Route |
| **状态管理** | Zustand + Immer | 轻量、支持时间旅行、不可变更新 |
| **画布引擎** | ReactFlow 12 | 成熟、可扩展、支持自定义节点 |
| **消息实时** | Socket.io | 比原生WebSocket更稳定，支持自动重连 |
| **后端运行时** | Node.js 20+ | 与前端同语言，生态丰富 |
| **消息队列** | Redis Streams | 轻量、持久化、支持消费者组 |
| **数据库存储** | PostgreSQL 16 | 关系型数据，JSONB支持灵活Schema |
| **缓存** | Redis 7 | 会话、消息、状态缓存 |
| **对象存储** | MinIO | S3兼容，本地开发友好 |
| **LLM集成** | Zhipu AI GLM-4.7 | 国内可用，中文效果好 |

---

## 7. 与 V1 的兼容性

### 7.1 保留的模块

| 模块 | 变更 | 说明 |
|------|------|------|
| 工作流引擎 | 保留 | 执行层无需修改 |
| DAG解析器 | 保留 | 支持现有解析逻辑 |
| 节点执行器 | 增强 | 新增 AgentNodeExecutor |
| 检查点系统 | 保留 | 状态恢复机制复用 |
| 数据库表 | 新增表 | 不修改现有表结构 |

### 7.2 废弃的模块

| 模块 | 替代方案 | 说明 |
|------|---------|------|
| useExecution Hook | 新 useAgentExecution | 改为调用 API 而非直接执行 |
| 手动节点添加 | AI生成 + 修改 | 减少用户手动操作 |
| 单一画布界面 | 三分屏界面 | 更丰富的信息展示 |

### 7.3 数据迁移

V1 的工作流数据可以直接在 V2 中打开和执行，但反向不完全兼容（V2 的 Agent 角色信息 V1 无法识别）。

---

## 8. 风险与缓解

| 风险 | 影响 | 缓解措施 |
|------|------|---------|
| Master Agent 生成质量不稳定 | 高 | 增加多轮确认机制，用户可随时干预修改 |
| LLM API 成本高 | 中 | 实现智能缓存，相似需求复用生成结果 |
| Agent 协作复杂性 | 高 | 从简单场景开始，逐步增加协作深度 |
| 实时通信性能 | 中 | 使用 Redis Pub/Sub 分流，WebSocket 仅推送 |
| 前端性能（三分屏） | 中 | 组件懒加载，虚拟滚动，避免重复渲染 |

---

## 9. 后续详细设计文档

请查阅以下详细设计文档:

1. **[Master Agent 设计](./master_agent_design.md)**
   - 需求解析器
   - 角色规划器
   - 任务拆分器
   - 工作流生成器

2. **[Agent Runtime 设计](./agent_runtime_design.md)**
   - Agent 生命周期管理
   - 消息总线实现
   - 状态管理
   - 上下文管理

3. **[三分屏前端设计](./frontend_v2_design.md)**
   - 布局架构
   - Agent Chat Panel
   - Workflow Canvas
   - Project Explorer

4. **[数据模型 V2](./data_model_v2_design.md)**
   - 新增实体
   - 关系变更
   - 迁移策略

5. **[IM 消息总线设计](./message_bus_design.md)**
   - 消息模型
   - Redis Streams 实现
   - 实时推送机制

6. **[API 接口设计 V2](./api_design_v2.md)**
   - REST API 规范
   - WebSocket 协议
   - 错误处理

---

**下一步**: 请查阅各子模块详细设计文档，然后开始实施。
