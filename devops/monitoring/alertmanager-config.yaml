# AI Agent Platform - AlertManager Configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: alertmanager-config
  namespace: monitoring
data:
  alertmanager.yml: |
    global:
      # SMTPé…ç½®
      smtp_smarthost: 'smtp.gmail.com:587'
      smtp_from: 'alerts@your-company.com'
      smtp_auth_username: 'alerts@your-company.com'
      smtp_auth_password: 'your-smtp-password'
      smtp_require_tls: true
      
      # Slacké…ç½®
      slack_api_url: 'https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK'
      
      # PagerDutyé…ç½®
      pagerduty_url: 'https://events.pagerduty.com/v2/enqueue'
      
      # é€šç”¨é…ç½®
      resolve_timeout: 5m

    # è·¯ç”±æ ‘é…ç½®
    route:
      receiver: 'default'
      group_by: ['alertname', 'severity', 'team']
      group_wait: 10s
      group_interval: 10s
      repeat_interval: 4h
      
      routes:
        # ä¸¥é‡å‘Šè­¦è·¯ç”±
        - match:
            severity: critical
          receiver: 'critical-alerts'
          group_wait: 0s
          group_interval: 5m
          repeat_interval: 1h
          continue: true
        
        # è­¦å‘Šå‘Šè­¦è·¯ç”±
        - match:
            severity: warning
          receiver: 'warning-alerts'
          group_wait: 30s
          group_interval: 10m
          repeat_interval: 4h
          continue: true
        
        # åŸºç¡€è®¾æ–½å‘Šè­¦è·¯ç”±
        - match:
            team: infrastructure
          receiver: 'infrastructure-team'
          group_wait: 30s
          continue: true
        
        # æ•°æ®åº“å‘Šè­¦è·¯ç”±
        - match:
            team: database
          receiver: 'database-team'
          group_wait: 30s
          continue: true
        
        # å¹³å°å‘Šè­¦è·¯ç”±
        - match:
            team: platform
          receiver: 'platform-team'
          group_wait: 30s
          continue: true

    # æŠ‘åˆ¶è§„åˆ™
    inhibit_rules:
      # ä¸¥é‡å‘Šè­¦æŠ‘åˆ¶è­¦å‘Šå‘Šè­¦
      - source_match:
          severity: 'critical'
        target_match:
          severity: 'warning'
        equal: ['alertname', 'instance']
      
      # ç›¸åŒå‘Šè­¦æŠ‘åˆ¶
      - source_match:
          alertname: 'PodCrashLooping'
        target_match:
          alertname: 'PodNotReady'
        equal: ['pod', 'namespace']

    # æ¥æ”¶å™¨é…ç½®
    receivers:
      - name: 'default'
        slack_configs:
          - channel: '#alerts'
            title: 'ğŸ”” {{ .GroupLabels.alertname }}'
            text: |
              {{ range .Alerts }}
              *Alert:* {{ .Annotations.summary }}
              *Description:* {{ .Annotations.description }}
              *Severity:* {{ .Labels.severity }}
              *Instance:* {{ .Labels.instance }}
              {{ end }}
            send_resolved: true

      - name: 'critical-alerts'
        slack_configs:
          - channel: '#critical-alerts'
            title: 'ğŸ”´ CRITICAL: {{ .GroupLabels.alertname }}'
            text: |
              {{ range .Alerts }}
              *Alert:* {{ .Annotations.summary }}
              *Description:* {{ .Annotations.description }}
              *Severity:* {{ .Labels.severity }}
              *Instance:* {{ .Labels.instance }}
              *Time:* {{ .StartsAt.Format "2006-01-02 15:04:05" }}
              {{ end }}
            send_resolved: true
            color: '{{ if eq .Status "firing" }}danger{{ else }}good{{ end }}'
        
        email_configs:
          - to: 'oncall@your-company.com'
            subject: 'ğŸ”´ CRITICAL Alert: {{ .GroupLabels.alertname }}'
            body: |
              {{ range .Alerts }}
              Alert: {{ .Annotations.summary }}
              Description: {{ .Annotations.description }}
              Severity: {{ .Labels.severity }}
              Instance: {{ .Labels.instance }}
              Started: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
              
              Labels:
              {{ range .Labels.SortedPairs }}
                {{ .Name }}: {{ .Value }}
              {{ end }}
              {{ end }}
            send_resolved: true
        
        pagerduty_configs:
          - service_key: 'your-pagerduty-service-key'
            severity: critical
            description: '{{ .GroupLabels.alertname }}'
            details:
              firing: '{{ template "pagerduty.default.instances" .Alerts.Firing }}'
              resolved: '{{ template "pagerduty.default.instances" .Alerts.Resolved }}'
              num_firing: '{{ .Alerts.Firing | len }}'
              num_resolved: '{{ .Alerts.Resolved | len }}'

      - name: 'warning-alerts'
        slack_configs:
          - channel: '#warnings'
            title: 'âš ï¸ WARNING: {{ .GroupLabels.alertname }}'
            text: |
              {{ range .Alerts }}
              *Alert:* {{ .Annotations.summary }}
              *Description:* {{ .Annotations.description }}
              *Severity:* {{ .Labels.severity }}
              *Instance:* {{ .Labels.instance }}
              {{ end }}
            send_resolved: true
            color: '{{ if eq .Status "firing" }}warning{{ else }}good{{ end }}'

      - name: 'infrastructure-team'
        slack_configs:
          - channel: '#infrastructure-alerts'
            title: 'ğŸ–¥ï¸ Infrastructure: {{ .GroupLabels.alertname }}'
            text: |
              {{ range .Alerts }}
              *Alert:* {{ .Annotations.summary }}
              *Description:* {{ .Annotations.description }}
              *Instance:* {{ .Labels.instance }}
              {{ end }}
            send_resolved: true
        
        email_configs:
          - to: 'infrastructure@your-company.com'
            subject: 'Infrastructure Alert: {{ .GroupLabels.alertname }}'
            send_resolved: true

      - name: 'database-team'
        slack_configs:
          - channel: '#database-alerts'
            title: 'ğŸ—„ï¸ Database: {{ .GroupLabels.alertname }}'
            text: |
              {{ range .Alerts }}
              *Alert:* {{ .Annotations.summary }}
              *Description:* {{ .Annotations.description }}
              *Instance:* {{ .Labels.instance }}
              {{ end }}
            send_resolved: true
        
        email_configs:
          - to: 'database@your-company.com'
            subject: 'Database Alert: {{ .GroupLabels.alertname }}'
            send_resolved: true

      - name: 'platform-team'
        slack_configs:
          - channel: '#platform-alerts'
            title: 'ğŸš€ Platform: {{ .GroupLabels.alertname }}'
            text: |
              {{ range .Alerts }}
              *Alert:* {{ .Annotations.summary }}
              *Description:* {{ .Annotations.description }}
              *Service:* {{ .Labels.service }}
              *Instance:* {{ .Labels.instance }}
              {{ end }}
            send_resolved: true

    # æ¨¡æ¿é…ç½®
    templates:
      - '/etc/alertmanager/templates/*.tmpl'
